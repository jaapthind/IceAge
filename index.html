<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>KartBros.io Clone</title>
<style>
  html, body { margin: 0; padding: 0; width: 100%; height: 100%; background: #27ae60; overflow: hidden; touch-action: none; font-family: 'Arial Black', sans-serif; }
  canvas { display: block; width: 100vw; height: 100vh; }
  #ui { position: absolute; top: 20px; left: 20px; color: white; pointer-events: none; }
  .stat { font-size: 28px; text-shadow: 2px 2px #000; margin: 5px 0; font-style: italic; }
  #minimap { position: absolute; bottom: 20px; left: 20px; width: 180px; height: 120px; background: rgba(0,0,0,0.4); border: 3px solid white; border-radius: 10px; pointer-events: none; }
</style>
</head>
<body>
<div id="ui">
  <div class="stat">LAP: <span id="lap">1/3</span></div>
  <div class="stat" id="speed">000 KM/H</div>
  <div class="stat" id="timer">00:00.00</div>
</div>
<canvas id="game"></canvas>
<canvas id="minimap"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const mCanvas = document.getElementById("minimap");
const mCtx = mCanvas.getContext("2d");

let W, H;
function resize() {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
    mCanvas.width = 180; mCanvas.height = 120;
}
window.addEventListener('resize', resize);
resize();

// --- TRACK DEFINITION (X, Y, Width, Height) ---
const track = [
  {x: 0, y: 0, w: 2500, h: 500},      // Start Straight
  {x: 2200, y: 0, w: 500, h: 2000},   // Right Curve
  {x: 800, y: 1700, w: 1700, h: 500}, // Bottom Straight
  {x: 800, y: 800, w: 500, h: 1200},  // Mid Connect
  {x: -500, y: 800, w: 1500, h: 500}, // Left Straight
  {x: -500, y: 0, w: 500, h: 1000}    // Final Turn
];

const boostPads = [
    {x: 1200, y: 150, w: 80, h: 200},
    {x: 1500, y: 1850, w: 80, h: 200}
];

// --- KART LOGIC ---
const player = {
    x: 400, y: 250,
    angle: 0,
    speed: 0,
    drift: 0,
    velX: 0, velY: 0,
    maxSpeed: 14,
    accel: 0.2,
    friction: 0.96,
    turnSpeed: 0.06,
    laps: 1,
    lastLapX: 400,
    startTime: Date.now()
};

const particles = [];
const keys = {};
window.addEventListener("keydown", e => keys[e.code] = true);
window.addEventListener("keyup", e => keys[e.code] = false);

function createSpark(x, y) {
    particles.push({ x, y, vx: (Math.random()-0.5)*5, vy: (Math.random()-0.5)*5, life: 1 });
}

function update() {
    // Timer
    const elapsed = (Date.now() - player.startTime) / 1000;
    const mins = Math.floor(elapsed / 60);
    const secs = (elapsed % 60).toFixed(2);
    document.getElementById("timer").innerText = `${mins}:${secs < 10 ? '0' : ''}${secs}`;

    // Controls
    if (keys["ArrowUp"] || keys["KeyW"]) player.speed += player.accel;
    if (keys["ArrowDown"] || keys["KeyS"]) player.speed -= player.accel * 0.5;

    let turning = false;
    let turnDir = 0;
    if (Math.abs(player.speed) > 1) {
        if (keys["ArrowLeft"] || keys["KeyA"]) { turnDir = -1; turning = true; }
        if (keys["ArrowRight"] || keys["KeyD"]) { turnDir = 1; turning = true; }
    }

    // Drifting Physics
    if (turning && Math.abs(player.speed) > 8) {
        player.drift += (turnDir * 0.05 - player.drift) * 0.15;
        if (Math.random() > 0.5) createSpark(player.x, player.y);
    } else {
        player.drift *= 0.8;
    }

    player.angle += (turnDir * player.turnSpeed) * (player.speed / 12);
    player.speed *= player.friction;

    player.velX = Math.cos(player.angle + player.drift) * player.speed;
    player.velY = Math.sin(player.angle + player.drift) * player.speed;

    player.x += player.velX;
    player.y += player.velY;

    // Off-road check
    let onRoad = false;
    track.forEach(s => {
        if (player.x > s.x && player.x < s.x + s.w && player.y > s.y && player.y < s.y + s.h) onRoad = true;
    });
    if (!onRoad) player.speed *= 0.94;

    // Boost Pad Logic
    boostPads.forEach(b => {
        if (player.x > b.x && player.x < b.x + b.w && player.y > b.y && player.y < b.y + b.h) {
            player.speed = 22;
        }
    });

    // Lap Logic
    if (player.x < 300 && player.lastLapX >= 300 && Math.abs(player.y - 250) < 500) {
        player.laps++;
        document.getElementById("lap").innerText = player.laps + "/3";
    }
    player.lastLapX = player.x;

    document.getElementById("speed").innerText = Math.floor(Math.abs(player.speed) * 12) + " KM/H";
}

function draw() {
    // BG
    ctx.fillStyle = "#27ae60";
    ctx.fillRect(0, 0, W, H);

    ctx.save();
    ctx.translate(W/2, H/2);
    // Dynamic Zoom
    let zoom = 1.2 - (Math.abs(player.speed) / 50);
    ctx.scale(zoom, zoom);
    ctx.translate(-player.x, -player.y);

    // Track
    track.forEach(s => {
        ctx.fillStyle = "#333";
        ctx.fillRect(s.x, s.y, s.w, s.h);
        // Curb details
        ctx.strokeStyle = "white";
        ctx.lineWidth = 10;
        ctx.setLineDash([30, 30]);
        ctx.strokeRect(s.x + 5, s.y + 5, s.w - 10, s.h - 10);
    });

    // Finish Line
    ctx.fillStyle = "white";
    for(let i=0; i<10; i++) ctx.fillRect(300, 0 + (i*50), 25, 25);
    for(let i=0; i<10; i++) ctx.fillRect(325, 25 + (i*50), 25, 25);

    // Boost Pads
    boostPads.forEach(b => {
        ctx.fillStyle = "#f1c40f";
        ctx.shadowBlur = 20; ctx.shadowColor = "yellow";
        ctx.fillRect(b.x, b.y, b.w, b.h);
        ctx.shadowBlur = 0;
    });

    // Particles
    particles.forEach((p, i) => {
        ctx.fillStyle = `rgba(255, 200, 0, ${p.life})`;
        ctx.fillRect(p.x, p.y, 4, 4);
        p.x += p.vx; p.y += p.vy; p.life -= 0.05;
        if (p.life <= 0) particles.splice(i, 1);
    });

    // Player Kart
    ctx.save();
    ctx.translate(player.x, player.y);
    ctx.rotate(player.angle);
    
    // Body
    ctx.fillStyle = "#e74c3c";
    ctx.fillRect(-22, -15, 44, 30);
    // Helmet
    ctx.fillStyle = "white";
    ctx.beginPath(); ctx.arc(-5, 0, 8, 0, Math.PI*2); ctx.fill();
    // Spoiler
    ctx.fillStyle = "#c0392b";
    ctx.fillRect(-30, -18, 10, 36);
    ctx.restore();

    ctx.restore();

    // --- MINIMAP ---
    mCtx.clearRect(0,0,180,120);
    mCtx.save();
    mCtx.scale(0.05, 0.05);
    mCtx.translate(500, 500);
    track.forEach(s => {
        mCtx.fillStyle = "rgba(255,255,255,0.5)";
        mCtx.fillRect(s.x, s.y, s.w, s.h);
    });
    mCtx.fillStyle = "red";
    mCtx.beginPath(); mCtx.arc(player.x, player.y, 100, 0, Math.PI*2); mCtx.fill();
    mCtx.restore();

    update();
    requestAnimationFrame(draw);
}

// Mobile Controls
canvas.addEventListener("touchstart", (e) => {
    const t = e.touches[0];
    if (t.clientY < H/3) keys["KeyW"] = true;
    else if (t.clientX < W/2) keys["KeyA"] = true;
    else keys["KeyD"] = true;
});
canvas.addEventListener("touchend", () => {
    keys["KeyW"] = false; keys["KeyA"] = false; keys["KeyD"] = false;
});

draw();
</script>
</body>
</html>
